const functions = require("firebase-functions");
const admin = require("firebase-admin");
const crypto = require("crypto");

admin.initializeApp();

exports.bitlabsRewardCallback = functions.https.onRequest((req, res) => {
  const { event, user, reward, tx, hash } = req.body;

  // Secure the callback with a hash
  const secretKey = process.env.BITLABS_SECRET_KEY;
  const computedHash = crypto.createHmac('sha1', secretKey)
    .update(`${tx}${reward}${user}`)
    .digest('hex');

  if (computedHash !== hash) {
    return res.status(400).send('Invalid callback hash');
  }

  if (event === "reward") {
    console.log(`Reward event for User ${user}: ${reward} points`);

    // Firestore: Update the user's balance
    const userRef = admin.firestore().collection("users").doc(user);
    userRef.update({
      balance: admin.firestore.FieldValue.increment(reward),
    })
    .then(() => {
      res.status(200).send("Reward processed successfully.");
    })
    .catch((err) => {
      console.error("Error updating user balance:", err);
      res.status(500).send("Error processing reward.");
    });
  } else {
    console.error("Invalid event type:", event);
    res.status(400).send("Invalid event type.");
  }
});
