<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J17 Login</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px; }
        #user-info, #error-msg { display: none; }
        #error-msg { color: red; }
    </style>
</head>
<body>
    <h1>Welcome to J17</h1>
    <button id="login-btn" onclick="login()">Sign in with Google</button>
    <button id="logout-btn" onclick="logout()" style="display: none;">Sign Out</button>
    <div id="user-info">
        <p>Logged in as: <span id="user-name"></span></p>
    </div>
    <div id="error-msg">
        <p>Sorry, your email is not allowed to access this app.</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpIapJzv54LIApO_yM2f-SrwkXbjjLRPo",
            authDomain: "ever4-e1efb.firebaseapp.com",
            projectId: "ever4-e1efb",
            storageBucket: "ever4-e1efb.firebasestorage.app",
            messagingSenderId: "473102358637",
            appId: "1:473102358637:web:a28114096fac995e640764",
            measurementId: "G-NX3JS6DVKB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Login function
        function login() {
            firebase.auth().signInWithRedirect(provider);
        }

        // Logout function
        function logout() {
            firebase.auth().signOut().then(() => {
                console.log("Logged out");
            }).catch((error) => {
                console.error("Logout error:", error);
            });
        }

        // Check if email is allowed
        function checkEmailAllowed(email) {
            db.collection("allowedEmails").doc(email).get()
                .then((doc) => {
                    const loginBtn = document.getElementById("login-btn");
                    const logoutBtn = document.getElementById("logout-btn");
                    const userInfo = document.getElementById("user-info");
                    const userName = document.getElementById("user-name");
                    const errorMsg = document.getElementById("error-msg");

                    if (doc.exists) {
                        // Email is allowed
                        loginBtn.style.display = "none";
                        logoutBtn.style.display = "inline";
                        userInfo.style.display = "block";
                        userName.textContent = auth.currentUser.displayName;
                        errorMsg.style.display = "none";
                        console.log("Email allowed:", email);
                    } else {
                        // Email not allowed, sign out
                        firebase.auth().signOut();
                        loginBtn.style.display = "inline";
                        logoutBtn.style.display = "none";
                        userInfo.style.display = "none";
                        errorMsg.style.display = "block";
                        console.log("Email not allowed:", email);
                    }
                })
                .catch((error) => {
                    console.error("Error checking email:", error);
                });
        }

        // Handle authentication state
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                checkEmailAllowed(user.email);
            } else {
                const loginBtn = document.getElementById("login-btn");
                const logoutBtn = document.getElementById("logout-btn");
                const userInfo = document.getElementById("user-info");
                const errorMsg = document.getElementById("error-msg");
                
                loginBtn.style.display = "inline";
                logoutBtn.style.display = "none";
                userInfo.style.display = "none";
                errorMsg.style.display = "none";
                console.log("No user signed in");
            }
        });

        // Handle redirect result
        firebase.auth().getRedirectResult()
            .then((result) => {
                if (result.user) {
                    console.log("Redirect login successful:", result.user.displayName);
                    checkEmailAllowed(result.user.email);
                }
            })
            .catch((error) => {
                console.error("Redirect login error:", error);
            });
    </script>
</body>
</html>
