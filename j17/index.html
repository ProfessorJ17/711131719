<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Iframe Access</title>
    <style>
        body {
            background-color: black;
            color: white;
            text-align: center;
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #name {
            margin-top: 20px;
            font-size: 1.5em;
        }
        #timer {
            margin-top: 10px;
            color: #ff5555;
            font-size: 1.2em;
        }
        #login-form {
            margin-top: 50px;
        }
        #iframe-container {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 600px;
            height: 100%;
            max-height: 400px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        input, button {
            display: block;
            width: 200px;
            padding: 10px;
            margin: 10px auto;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            font-size: 1em;
        }
        button:hover {
            background-color: #555;
        }
        #logout-button {
            display: none;
        }
    </style>
</head>
<body>
    <div id="name"></div>
    <div id="timer">Time left: 00:00</div>
    <div id="login-form">
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button id="login-btn">Login</button>
    </div>
    <button id="logout-button" style="display: none;">Logout</button>
    <div id="iframe-container"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js';

        console.log('Module script loaded');

        const firebaseConfig = {
            apiKey: "AIzaSyDpIapJzv54LIApO_yM2f-SrwkXbjjLRPo",
            authDomain: "ever4-e1efb.firebaseapp.com",
            projectId: "ever4-e1efb",
            storageBucket: "ever4-e1efb.appspot.com",
            messagingSenderId: "473102358637",
            appId: "1:473102358637:web:a28114096fac995e640764"
        };

        try {
            const app = initializeApp(firebaseConfig);
            console.log('Firebase initialized');
            const auth = getAuth(app);
            const db = getFirestore(app);

            const sessionDuration = 5 * 60 * 1000; // 5 minutes
            const lockoutDuration = 24 * 60 * 60 * 1000 - sessionDuration; // 23h 55m
            let countdownInterval = null;

            // Login button
            document.getElementById('login-btn').addEventListener('click', async () => {
                console.log('Login button clicked');
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();

                if (!email || !password) {
                    console.log('Missing email or password');
                    alert('Please enter both email and password');
                    return;
                }

                try {
                    console.log('Attempting login with:', email);
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    console.log('Login successful:', userCredential.user.email);
                } catch (error) {
                    console.error('Login error:', error.code, error.message);
                    alert(`Login error: ${error.message}`);
                }
            });

            // Logout button
            document.getElementById('logout-button').addEventListener('click', async () => {
                console.log('Logout button clicked');
                clearInterval(countdownInterval);
                await signOut(auth);
            });

            // Auth state listener
            onAuthStateChanged(auth, user => {
                console.log('Auth state changed:', user ? user.email : 'No user');
                if (user) {
                    document.getElementById("login-form").style.display = "none";
                    document.getElementById("logout-button").style.display = "block";
                    checkAccess(user);
                } else {
                    resetUI();
                }
            });

            async function checkAccess(user) {
                console.log('Checking access for:', user.email);
                const allowedEmailRef = doc(db, "allowedEmails", user.email);
                const allowedEmailDoc = await getDoc(allowedEmailRef);

                if (!allowedEmailDoc.exists() || !allowedEmailDoc.data().purchased) {
                    console.log('User not authorized or not purchased');
                    alert("Email not authorized or purchase required.");
                    await signOut(auth);
                    return;
                }

                const userData = allowedEmailDoc.data();
                document.getElementById("name").textContent = userData.name || "User";
                console.log('Name set to:', userData.name);

                const userRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userRef);
                const now = Date.now();
                const sessionData = userDoc.exists() ? userDoc.data() : {};
                const lockoutUntil = sessionData.lockoutUntil || 0;

                if (now < lockoutUntil) {
                    const timeLeft = Math.ceil((lockoutUntil - now) / 1000);
                    console.log('User locked out, time left:', timeLeft);
                    startLockoutCountdown(timeLeft);
                    return;
                }

                console.log('Granting new session');
                await setDoc(userRef, {
                    name: userData.name,
                    purchased: true,
                    startTime: now,
                    lockoutUntil: now + sessionDuration + lockoutDuration
                }, { merge: true });
                grantAccess();
            }

            function grantAccess() {
                console.log('Granting access');
                const iframeContainer = document.getElementById("iframe-container");
                loadDIDAgent(iframeContainer);
                iframeContainer.style.display = "block";
                startCountdown(sessionDuration / 1000);

                setTimeout(async () => {
                    iframeContainer.style.display = "none";
                    await signOut(auth);
                    console.log('Session ended');
                }, sessionDuration);
            }

            function loadDIDAgent(container) {
                if (!container.querySelector('script')) {
                    const script = document.createElement('script');
                    script.src = 'https://agent.d-id.com/v1/index.js';
                    script.setAttribute('data-name', 'did-agent');
                    script.setAttribute('data-mode', 'fabio');
                    script.setAttribute('data-client-key', 'Z29vZ2xlLW9hdXRoMnwxMDI1NDc5NDg2ODI5NjkwNzc4MDg6RkpFT0VWOTBqYVFVb3lHT3hMU2Zt');
                    script.setAttribute('data-agent-id', 'agt_k9HerVqC');
                    script.setAttribute('data-monitor', 'true');
                    container.appendChild(script);
                    console.log('D-ID Agent script loaded');
                }
            }

            function startCountdown(seconds) {
                const timer = document.getElementById('timer');
                timer.textContent = `Time left: ${formatTime(seconds)}`;

                clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    seconds--;
                    timer.textContent = `Time left: ${formatTime(seconds)}`;
                    if (seconds <= 0) clearInterval(countdownInterval);
                }, 1000);
            }

            function startLockoutCountdown(seconds) {
                const timer = document.getElementById('timer');
                timer.textContent = `Next session in: ${formatTime(seconds)}`;

                clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    seconds--;
                    timer.textContent = `Next session in: ${formatTime(seconds)}`;
                    if (seconds <= 0) {
                        clearInterval(countdownInterval);
                        resetUI();
                    }
                }, 1000);
            }

            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            function resetUI() {
                document.getElementById("login-form").style.display = "block";
                document.getElementById("logout-button").style.display = "none";
                document.getElementById("iframe-container").style.display = "none";
                document.getElementById("name").textContent = "";
                document.getElementById("timer").textContent = "Time left: 00:00";
                clearInterval(countdownInterval);
                console.log('UI reset');
            }

            window.onbeforeunload = async () => {
                clearInterval(countdownInterval);
                if (auth.currentUser) await signOut(auth);
            };
        } catch (error) {
            console.error('Initialization error:', error);
            alert('Failed to initialize app: ' + error.message);
        }
    </script>
</body>
</html>
