<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure D-ID Agent with Timer</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
    <style>
        body { background-color: black; margin: 0; overflow: hidden; color: white; text-align: center; }
        #character-container { display: none; position: fixed; bottom: 0; right: 0; z-index: 2; }
        #login-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3; }
        #timer { font-size: 24px; margin-top: 20px; }
        input, button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <!-- Login / Signup UI -->
    <div id="login-container">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Timer Display -->
    <h2 id="timer">Time Left: --:--</h2>

    <!-- D-ID Character Container -->
    <div id="character-container"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpIapJzv54LIApO_yM2f-SrwkXbjjLRPo",
            authDomain: "ever4-e1efb.firebaseapp.com",
            projectId: "ever4-e1efb",
            storageBucket: "ever4-e1efb.firebasestorage.app",
            messagingSenderId: "473102358637",
            appId: "1:473102358637:web:a28114096fac995e640764",
            measurementId: "G-NX3JS6DVKB"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let timerInterval;
        let remainingTime = 0;

        function signup() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => alert("Signup successful! Please log in."))
                .catch(error => alert("Error: " + error.message));
        }

        function login() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    alert("Login successful!");
                    checkAccess(userCredential.user.uid);
                })
                .catch(error => alert("Error: " + error.message));
        }

        function logout() {
            auth.signOut().then(() => {
                alert("Logged out!");
                document.getElementById("character-container").style.display = "none";
                clearInterval(timerInterval);
                document.getElementById("timer").textContent = "Time Left: --:--";
            }).catch(error => alert("Error: " + error.message));
        }

        async function checkAccess(userId) {
            const accessDoc = db.collection("userAccess").doc(userId);
            const doc = await accessDoc.get();

            const now = new Date();
            const lastAccess = doc.exists ? doc.data().timestamp.toDate() : null;

            if (lastAccess) {
                const elapsed = (now - lastAccess) / 1000; // Seconds passed
                remainingTime = 5 * 60 - elapsed; // 5 minutes timer
                const timeLeftForNextAccess = 24 * 60 * 60 - elapsed;

                if (timeLeftForNextAccess > 0 && remainingTime <= 0) {
                    // If 24h has not passed and time is over
                    showCountdown(timeLeftForNextAccess);
                    return;
                }

                if (remainingTime > 0) {
                    // Resume timer from remaining time
                    showDIDAgent(remainingTime);
                    return;
                }
            }

            // Start new session
            await accessDoc.set({ timestamp: firebase.firestore.Timestamp.now() });
            showDIDAgent(5 * 60); // 5 minutes
        }

        function showDIDAgent(timeLeft) {
            remainingTime = timeLeft;
            document.getElementById("character-container").style.display = "block";
            loadDIDAgent(document.getElementById("character-container"));
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (remainingTime > 0) {
                    remainingTime--;
                    updateTimerDisplay(remainingTime);
                } else {
                    clearInterval(timerInterval);
                    document.getElementById("character-container").style.display = "none";
                    alert("Time's up! You can access it again in 24 hours.");
                    start24hCountdown();
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            let minutes = Math.floor(seconds / 60);
            let sec = seconds % 60;
            document.getElementById("timer").textContent = `Time Left: ${minutes}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function start24hCountdown() {
            let remaining = 24 * 60 * 60;
            showCountdown(remaining);
        }

        function showCountdown(timeLeft) {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    let hours = Math.floor(timeLeft / 3600);
                    let minutes = Math.floor((timeLeft % 3600) / 60);
                    let seconds = timeLeft % 60;
                    document.getElementById("timer").textContent = `Next access in: ${hours}:${minutes}:${seconds}`;
                } else {
                    clearInterval(timerInterval);
                    document.getElementById("timer").textContent = "You can now access the agent!";
                }
            }, 1000);
        }

        function loadDIDAgent(container) {
            if (!container.querySelector('script')) {
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'https://agent.d-id.com/v1/index.js';
                script.setAttribute('data-name', 'did-agent');
                script.setAttribute('data-mode', 'fabio');
                script.setAttribute('data-client-key', 'Z29vZ2xlLW9hdXRoMnwxMDI1NDc5NDg2ODI5NjkwNzc4MDg6RkpFT0VWOTBqYVFVb3lHT3hMU2Zt');
                script.setAttribute('data-agent-id', 'agt_k9HerVqC');
                script.setAttribute('data-monitor', 'true');
                container.appendChild(script);
                console.log('D-ID Agent script loaded');
            }
        }
    </script>
</body>
</html>
