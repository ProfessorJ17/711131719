<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Login Page</title>
    <!-- Include Firebase libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-functions.js"></script>
  </head>
  <body>
    <!-- Login Form -->
    <div id="login-div">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" /><br>
      <input type="password" id="password" placeholder="Password" /><br>
      <button id="login">Login</button>
    </div>
    <!-- Content Displayed After Login -->
    <div id="content" style="display:none;"></div>
    <button id="logout" style="display:none;">Logout</button>

    <script>
      // Firebase configuration with your credentials
      const firebaseConfig = {
        apiKey: "AIzaSyDpIapJzv54LIApO_yM2f-SrwkXbjjLRPo",
        authDomain: "ever4-e1efb.firebaseapp.com",
        projectId: "ever4-e1efb",
        storageBucket: "ever4-e1efb.firebasestorage.app",
        messagingSenderId: "473102358637",
        appId: "1:473102358637:web:a28114096fac995e640764",
        measurementId: "G-NX3JS6DVKB"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const functions = firebase.functions();

      // Login button event listener
      document.getElementById("login").addEventListener("click", () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            // Hide login form on success
            document.getElementById("login-div").style.display = "none";
          })
          .catch((error) => {
            alert("Error: " + error.message);
          });
      });

      // Monitor authentication state changes
      auth.onAuthStateChanged(async (user) => {
        const contentEl = document.getElementById("content");
        const logoutBtn = document.getElementById("logout");

        if (user) {
          // Call the Cloud Function to verify access
          const checkAccess = functions.httpsCallable('checkAccess');
          try {
            const result = await checkAccess();
            if (result.data.access === true) {
              contentEl.innerHTML = `<h3>Logged in after: Welcome ${user.email}</h3>`;
              contentEl.style.display = "block";
              logoutBtn.style.display = "block";
            } else {
              contentEl.innerHTML = `<h3>Access Denied. Purchase required to view this page.</h3>`;
              contentEl.style.display = "block";
              logoutBtn.style.display = "none";
            }
          } catch (error) {
            console.error("Error calling checkAccess:", error);
          }
        } else {
          // Reset UI for logged-out state
          document.getElementById("login-div").style.display = "block";
          contentEl.style.display = "none";
          logoutBtn.style.display = "none";
        }
      });

      // Logout button event listener
      document.getElementById("logout").addEventListener("click", () => {
        auth.signOut().then(() => {
          document.getElementById("login-div").style.display = "block";
          document.getElementById("content").style.display = "none";
          document.getElementById("logout").style.display = "none";
        });
      });
    </script>
  </body>
</html>
