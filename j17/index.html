<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-ID Agent Access</title>
    <style>
        body {
            background-color: black;
            margin: 0;
            overflow: hidden;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #name {
            margin-top: 20px;
            font-size: 1.5em;
        }
        #timer {
            margin-top: 10px;
            color: #ff5555;
            font-size: 1.2em;
        }
        #login-form {
            margin-top: 50px;
        }
        #logout-button {
            display: none;
            width: 200px;
            padding: 10px;
            margin: 20px auto;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            font-size: 1em;
        }
        #logout-button:hover {
            background-color: #555;
        }
        #character-container {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 600px;
            height: 100%;
            max-height: 400px;
            z-index: 2;
        }
        input, button {
            display: block;
            width: 200px;
            padding: 10px;
            margin: 10px auto;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            font-size: 1em;
        }
        button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="name"></div>
    <div id="timer">Time left: 00:00</div>
    <div id="login-form">
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button id="login-btn">Login</button>
    </div>
    <button id="logout-button">Logout</button>
    <div id="character-container"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-functions.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const checkAccessFn = httpsCallable(functions, 'checkAccess');

        let countdownInterval = null;

        // Login button
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert(`Login error: ${error.message}`);
            }
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', async () => {
            clearInterval(countdownInterval);
            await signOut(auth);
        });

        // Auth state listener
        onAuthStateChanged(auth, async user => {
            if (user) {
                document.getElementById("login-form").style.display = "none";
                document.getElementById("logout-button").style.display = "block";
                await checkAccess(user);
            } else {
                resetUI();
            }
        });

        async function checkAccess(user) {
            // Get user name from Firestore (or use "jesse33" as default)
            const allowedEmailRef = doc(db, "allowedEmails", user.email);
            const allowedEmailDoc = await getDoc(allowedEmailRef);

            if (!allowedEmailDoc.exists() || !allowedEmailDoc.data().purchased) {
                alert("Email not authorized or purchase required.");
                await signOut(auth);
                return;
            }

            const userData = allowedEmailDoc.data();
            document.getElementById("name").textContent = userData.name || "jesse33";

            // Call Cloud Function to check access
            try {
                const result = await checkAccessFn();
                const { access, timeLeft } = result.data;

                if (access) {
                    grantAccess(timeLeft);
                } else {
                    startLockoutCountdown(timeLeft, "Next session in");
                }
            } catch (error) {
                alert(`Access check failed: ${error.message}`);
                await signOut(auth);
            }
        }

        function grantAccess(seconds) {
            const container = document.getElementById("character-container");
            loadDIDAgent(container);
            container.style.display = "block";
            startCountdown(seconds, "Time left");
            document.getElementById("logout-button").style.display = "block";

            setTimeout(async () => {
                container.style.display = "none";
                await signOut(auth);
            }, seconds * 1000);
        }

        function loadDIDAgent(container) {
            if (!container.querySelector('script')) {
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'https://agent.d-id.com/v1/index.js';
                script.setAttribute('data-name', 'did-agent');
                script.setAttribute('data-mode', 'fabio');
                script.setAttribute('data-client-key', 'YOUR_D-ID_CLIENT_KEY');
                script.setAttribute('data-agent-id', 'YOUR_AGENT_ID');
                script.setAttribute('data-monitor', 'true');
                container.appendChild(script);
            }
        }

        function startCountdown(seconds, label) {
            const timer = document.getElementById('timer');
            timer.textContent = `${label}: ${formatTime(seconds)}`;

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                seconds--;
                timer.textContent = `${label}: ${formatTime(seconds)}`;
                if (seconds <= 0) clearInterval(countdownInterval);
            }, 1000);
        }

        function startLockoutCountdown(seconds, label) {
            const timer = document.getElementById('timer');
            timer.textContent = `${label}: ${formatTime(seconds)}`;

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                seconds--;
                timer.textContent = `${label}: ${formatTime(seconds)}`;
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    resetUI();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function resetUI() {
            document.getElementById("login-form").style.display = "block";
            document.getElementById("logout-button").style.display = "none";
            document.getElementById("character-container").style.display = "none";
            document.getElementById("name").textContent = "";
            document.getElementById("timer").textContent = "Time left: 00:00";
            clearInterval(countdownInterval);
        }
    </script>
</body>
</html>
