<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-ID Agent with Firebase</title>
    <style>
        body {
            background-color: black;
            margin: 0;
            overflow: hidden;
        }
        .iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #did-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="iframe-container">
        <iframe id="did-iframe"></iframe>
    </div>

    <script type="module">
        // Firebase initialization
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDpIapJzv54LIApO_yM2f-SrwkXbjjLRPo",
            authDomain: "ever4-e1efb.firebaseapp.com",
            projectId: "ever4-e1efb",
            storageBucket: "ever4-e1efb.firebasestorage.app",
            messagingSenderId: "473102358637",
            appId: "1:473102358637:web:a28114096fac995e640764",
            measurementId: "G-NX3JS6DVKB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Function to load D-ID Agent
        function loadDIDAgent(container) {
            if (!container.querySelector('script')) {
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'https://agent.d-id.com/v1/index.js';
                script.setAttribute('data-name', 'did-agent');
                script.setAttribute('data-mode', 'fabio');
                script.setAttribute('data-client-key', 'Z29vZ2xlLW9hdXRoMnwxMDI1NDc5NDg2ODI5NjkwNzc4MDg6RkpFT0VWOTBqYVFVb3lHT3hMU2Zt');
                script.setAttribute('data-agent-id', 'agt_k9HerVqC');
                script.setAttribute('data-monitor', 'true');
                container.appendChild(script);
                console.log('D-ID Agent script loaded');
                script.onload = () => console.log('D-ID Agent script fully loaded');
            }
        }

        // Handle authentication state
        onAuthStateChanged(auth, (user) => {
            const iframe = document.getElementById('did-iframe');
            if (user) {
                // User is logged in, load D-ID agent in iframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body { margin: 0; background-color: black; }
                            #character-container { position: fixed; bottom: 0; right: 0; z-index: 2; }
                        </style>
                    </head>
                    <body>
                        <div id="character-container"></div>
                    </body>
                    </html>
                `);
                iframeDoc.close();

                // Load D-ID agent into the iframe's character container
                const container = iframeDoc.getElementById('character-container');
                loadDIDAgent(container);
            } else {
                // User is not logged in, redirect to login
                window.location.href = '/login'; // Adjust this to your login page URL
            }
        });
    </script>
</body>
</html>
