<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protected Agent Page</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="protectedContent" style="display: none;">
    <h1>Agent Interaction</h1>
    <p>Welcome! Interact with the agent below.</p>
    <script
      type="module"
      src="https://agent.d-id.com/v1/index.js"
      data-name="did-agent"
      data-mode="fabio"
      data-client-key="Z29vZ2xlLW9hdXRoMnwxMDI1NDc5NDg2ODI5NjkwNzc4MDg6RkpFT0VWOTBqYVFVb3lHT3hMU2Zt"
      data-agent-id="agt_k9HerVqC"
      data-monitor="true">
    </script>
    <a href="index.html">Back to Home</a>
  </div>
  <div id="unauthorized" style="display: none;">
    <h1>Access Denied</h1>
    <p>Please log in and purchase to view this page.</p>
    <a href="index.html">Go to Login</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="config.js"></script>
  <script>
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await user.reload();
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (user.emailVerified && userDoc.exists && userDoc.data().purchased === true) {
          document.getElementById("protectedContent").style.display = "block";
          document.getElementById("unauthorized").style.display = "none";
        } else {
          auth.signOut();
          document.getElementById("protectedContent").style.display = "none";
          document.getElementById("unauthorized").style.display = "block";
          setTimeout(() => window.location.href = "index.html", 2000);
        }
      } else {
        document.getElementById("protectedContent").style.display = "none";
        document.getElementById("unauthorized").style.display = "block";
        setTimeout(() => window.location.href = "index.html", 2000);
      }
    });
  </script>
</body>
</html>
