<!DOCTYPE html>
<html>
<head>
    <title>Homepage</title>
    <link rel="stylesheet" href="main.css">
    <style>
        body {
            background-color: #0583D2;
            font-family: sans-serif;
        }
        .homepage-container {
            background-color: white;
            padding: 5%;
            width: 50vw;
            margin: 10vh auto;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            text-align: center;
        }
        #logout-btn {
            background-color: #0583D2;
            color: white;
            border: none;
            padding: 2%;
            margin-top: 5%;
            width: 50%;
            cursor: pointer;
        }
        #logout-btn:hover {
            opacity: 0.8;
            transition: 0.3s;
        }
    </style>
</head>
<body>
    <div class="homepage-container">
        <p>Time Remaining Today: <span id="time-remaining"></span></p>
        <h1>Welcome <span id="username"></span>!</h1>
        <p>Subscription Status: <span id="purchase-status"></span></p>
        <button id="logout-btn">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpIapJzv54LIApO_yM2f-SrwkXbjjLRPo",
            authDomain: "ever4-e1efb.firebaseapp.com",
            projectId: "ever4-e1efb",
            storageBucket: "ever4-e1efb.firebasestorage.app",
            messagingSenderId: "473102358637",
            appId: "1:473102358637:web:a28114096fac995e640764",
            measurementId: "G-NX3JS6DVKB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const MAX_DAILY_MINUTES = 5;
        const MILLISECONDS_PER_MINUTE = 60000;

        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData) {
            window.location.href = 'index.html';
            throw new Error("No user data");
        }

        // Fetch latest user data from Firestore
        async function getLatestUserData() {
            const userDoc = await getDoc(doc(db, "users", userData.uid));
            if (userDoc.exists()) {
                userData.purchased = userDoc.data().purchased || false;
                localStorage.setItem('userData', JSON.stringify(userData));
            } else {
                await setDoc(doc(db, "users", userData.uid), {
                    email: userData.email,
                    purchased: false
                });
                userData.purchased = false;
                localStorage.setItem('userData', JSON.stringify(userData));
            }
            return userData.purchased;
        }

        // DOM elements
        const usernameDisplay = document.getElementById('username');
        const purchaseStatusDisplay = document.getElementById('purchase-status');
        const timeDisplay = document.getElementById('time-remaining');
        const logoutBtn = document.getElementById('logout-btn');

        // Format time function
        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        }

        // Update time and display in real-time
        async function updateTimeUsed(startTime) {
            const today = new Date().toISOString().split('T')[0];
            const userTimeDoc = doc(db, "userTime", userData.uid);
            const docSnap = await getDoc(userTimeDoc);
            let timeUsed = 0;

            if (docSnap.exists() && docSnap.data().date === today) {
                timeUsed = docSnap.data().timeUsed;
            } else {
                await setDoc(userTimeDoc, { date: today, timeUsed: 0 });
                timeUsed = 0;
            }

            const elapsed = Date.now() - startTime;
            const totalTimeUsed = timeUsed + elapsed;
            const timeRemaining = Math.max(0, MAX_DAILY_MINUTES * MILLISECONDS_PER_MINUTE - totalTimeUsed);
            
            timeDisplay.textContent = formatTime(timeRemaining);

            await updateDoc(userTimeDoc, {
                timeUsed: totalTimeUsed,
                date: today
            });

            if (timeRemaining <= 0) {
                window.alert("Your daily time limit has been reached.");
                await signOut(auth);
                localStorage.removeItem('userData');
                window.location.href = 'index.html';
            }
            return timeRemaining;
        }

        // Initialize page
        const startTime = Date.now();
        getLatestUserData().then((purchased) => {
            usernameDisplay.textContent = userData.name;
            purchaseStatusDisplay.textContent = purchased ? 'Active' : 'Inactive';
            timeDisplay.textContent = formatTime(userData.timeRemaining);

            // Start real-time timer
            let timer = setInterval(async () => {
                await updateTimeUsed(startTime);
            }, 1000);

            // Logout button handler
            logoutBtn.addEventListener('click', async () => {
                clearInterval(timer);
                await updateTimeUsed(startTime);
                await signOut(auth).then(() => {
                    localStorage.removeItem('userData');
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error("Logout error:", error);
                    window.alert("Error during logout: " + error.message);
                });
            });

            // Cleanup on page unload
            window.addEventListener('beforeunload', async () => {
                clearInterval(timer);
                await updateTimeUsed(startTime);
            });
        }).catch((error) => {
            console.error("Error fetching user data:", error);
            window.alert("Error initializing page: " + error.message);
        });
    </script>
</body>
</html>
